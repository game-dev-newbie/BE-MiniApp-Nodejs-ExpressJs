//////////////////////////////////////////////////////
// USERS & AUTH
//////////////////////////////////////////////////////

Table users {
  id           bigint [pk, increment]
  display_name varchar(255)
  email        varchar(255) [null, unique]
  phone        varchar(255) [null]
  avatar_url   varchar(255) [null]

  created_at   datetime
  updated_at   datetime
}

Table user_auth_providers {
  id                bigint [pk, increment]
  user_id           bigint
  provider          varchar(255)      // "ZALO", "GOOGLE", ...
  provider_user_id  varchar(255)

  created_at        datetime
  updated_at        datetime

  Indexes {
    (provider, provider_user_id) [unique]
  }
}

Table auth_tokens {
  id           bigint [pk, increment]
  subject_id   bigint              // id của user/restaurant_account...
  subject_type varchar(50)         // "CUSTOMER" | "RESTAURANT_ACCOUNT" | ...
  token_id     varchar(255)        // tid trong JWT refresh
  type         varchar(50)         // "REFRESH"
  is_revoked   boolean [default: false]
  expires_at   datetime

  created_at   datetime
  updated_at   datetime

  Indexes {
    (subject_id, subject_type, type)
    (token_id) [unique]
  }
}

//////////////////////////////////////////////////////
// RESTAURANTS & ACCOUNTS
//////////////////////////////////////////////////////

Table restaurants {
  id                     bigint [pk, increment]
  name                   varchar(255)
  address                text
  phone                  varchar(255)
  description            text        [null]

  tags                   varchar(255) [null]      // lưu từ khóa thô
  search_name            varchar(255) [null]      // name chuẩn hóa cho search
  search_address         varchar(255) [null]
  search_tags            varchar(255) [null]

  require_deposit        boolean     [default: false]
  default_deposit_amount int         [default: 0]

  is_active              boolean     [default: true]

  average_rating         float       [default: 0]
  review_count           int         [default: 0]

  invite_code            varchar(255) [unique]    // dùng cho staff register bằng mã mời

  created_at             datetime
  updated_at             datetime
}

Table restaurant_accounts {
  id            bigint [pk, increment]
  restaurant_id bigint

  full_name     varchar(255)
  email         varchar(255) [unique]
  password_hash varchar(255)

  role          varchar(50)          // OWNER | STAFF (map với RESTAURANT_ACCOUNT_ROLE)
  status        varchar(50)          // ACTIVE | INACTIVE | PENDING...

  avatar_url    varchar(255) [null]

  created_at    datetime
  updated_at    datetime
}

//////////////////////////////////////////////////////
// TABLES & BOOKINGS
//////////////////////////////////////////////////////

Table restaurant_tables {
  id            bigint [pk, increment]
  restaurant_id bigint
  name          varchar(255)         // Tên bàn, ví dụ "Bàn 1", "Sofa 3"
  capacity      int                  // số lượng người
  location      varchar(255) [null]  // mô tả vị trí (tầng 1, gần cửa sổ...)

  status        varchar(50)          // AVAILABLE | UNAVAILABLE...

  view_image_url varchar(255) [null] // ảnh sơ đồ / view bàn
  view_note      varchar(255) [null] // ghi chú thêm

  created_at     datetime
  updated_at     datetime
}

Table bookings {
  id             bigint [pk, increment]
  restaurant_id  bigint
  table_id       bigint
  user_id        bigint

  people_count   int
  booking_time   datetime

  status         varchar(50)         // PENDING | CONFIRMED | CANCELLED | COMPLETED...
  deposit_amount int     [default: 0]
  payment_status varchar(50) [default: "NONE"]  // NONE | PAID | REFUNDED...

  note           text   [null]

  created_at     datetime
  updated_at     datetime

  Indexes {
    (restaurant_id, booking_time)
    (user_id, booking_time)
  }
}

//////////////////////////////////////////////////////
// PAYMENTS & REVIEWS
//////////////////////////////////////////////////////

Table payments {
  id         bigint [pk, increment]
  booking_id bigint

  amount     int
  provider   varchar(50)  // "VNPAY", "MOMO", "CASH", "ZALOPAY"...
  status     varchar(50)  // PENDING | SUCCESS | FAILED...

  created_at datetime
  updated_at datetime
}

Table reviews {
  id            bigint [pk, increment]
  booking_id    bigint
  restaurant_id bigint
  user_id       bigint

  rating        int
  comment       text    [null]
  status        varchar(50) [default: "VISIBLE"] // HIDDEN nếu admin/owner ẩn

  created_at    datetime
  updated_at    datetime

  Indexes {
    (booking_id) [unique] // 1 booking 1 review
  }
}

//////////////////////////////////////////////////////
// FAVORITES, NOTIFICATIONS, IMAGES
//////////////////////////////////////////////////////

Table favorite_restaurants {
  id            bigint [pk, increment]
  user_id       bigint
  restaurant_id bigint

  created_at    datetime

  Indexes {
    (user_id, restaurant_id) [unique]
  }
}

Table notifications {
  id            bigint [pk, increment]
  user_id       bigint [null] // noti cho khách
  restaurant_id bigint [null] // noti cho nhà hàng

  type          varchar(50)   // NEW_BOOKING | BOOKING_STATUS_CHANGED...
  title         varchar(255)
  message       text

  channel       varchar(50) [default: "IN_APP"]  // IN_APP | EMAIL | SMS...
  is_read       boolean     [default: false]
  read_at       datetime

  created_at    datetime
  sent_at       datetime
}

Table restaurant_images {
  id            bigint [pk, increment]
  restaurant_id bigint

  file_path     varchar(255)
  type          varchar(50)          // COVER | GALLERY | MENU...
  caption       varchar(255) [null]
  is_primary    boolean [default: false]

  created_at    datetime
}

//////////////////////////////////////////////////////
// RELATIONSHIPS
//////////////////////////////////////////////////////

Ref: user_auth_providers.user_id       > users.id

Ref: restaurant_accounts.restaurant_id > restaurants.id
Ref: restaurant_tables.restaurant_id   > restaurants.id

Ref: bookings.restaurant_id           > restaurants.id
Ref: bookings.table_id                > restaurant_tables.id
Ref: bookings.user_id                 > users.id

Ref: payments.booking_id              > bookings.id

Ref: reviews.booking_id               > bookings.id
Ref: reviews.restaurant_id            > restaurants.id
Ref: reviews.user_id                  > users.id

Ref: favorite_restaurants.user_id       > users.id
Ref: favorite_restaurants.restaurant_id > restaurants.id

Ref: notifications.user_id       > users.id
Ref: notifications.restaurant_id > restaurants.id

Ref: restaurant_images.restaurant_id > restaurants.id
